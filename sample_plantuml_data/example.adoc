@startuml

title "Oauth 2.0 based Epic Launch"

hide footbox
autonumber "[0] "

participant "Patient" as Client << (U, #ccebc5) user >>

participant "Orchestration Layer" as Epic << (C, #b3cde3) Vidyo >>
participant "Vidyo Epic Service" as VidyoEpicService << (C, #b3cde3) Vidyo >>
note over VidyoEpicService
This is where you can put useful information like links to documentation or support processes.
end note

participant "Portal" as NSS << (C, #b3cde3) Vidyo >>

participant "APNS" as APNS << (E, #fbb4ae) external >>
participant "GCM" as GCM << (E, #fbb4ae) external >>

==Customer Action==

Client -> Client: First time login, or app upgrade, or user toggles notifications on/off in the app.

==Device Registration==

Client -> APNS: If iOS, register device token in APNS
Client -> GCM: If Android, register device token in GCM

==Update Messaging Server==

Client -> Epic: Update device token

Epic -> VidyoEpicService: Get existing subscriptions
VidyoEpicService -> Epic: If success, return all
Epic -> Epic: Check if device token is present

Epic -> VidyoEpicService: If device token is present, stop (skip to next group)

Epic -> VidyoEpicService: If device token not present, add subscription
note left
{ "device_token" : "APA91bE_YiasYasbda..." }
end note
VidyoEpicService -> Epic: Return success/failure

==Update Master Subscription==

Epic -> NSS: Register device token
NSS -> Epic: Return success/failure

Epic -> Epic: Swallow failure 
Epic -> Client: Return success/failure

==Replicate Subscriptions==

Client -> Epic: Update subscriptions 
Epic -> VidyoEpicService: Update subscriptions

VidyoEpicService -> VidyoEpicService: Update subscription in Messaging Server

VidyoEpicService -> Epic: Return success/failure
Epic -> Epic: Swallow failure
Epic -> Client: Return success/failure

@enduml
