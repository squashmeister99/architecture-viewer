@startuml
title "Oauth 2.0 based Epic Launch"
hide footbox
autonumber "[0] "

participant "Patient" as Patient << (U, #ccebc5) user >>
participant "Browser" as Browser << (U, #ccebc5) user >>

participant "Vidyo Epic Service" as VidyoEpicService << (C, #b3cde3) Vidyo >>
note over VidyoEpicService
manages all communication with Epic backend service
participant "Portal" as Portal << (C, #b3cde3) Vidyo >>
participant "Portal Database" as PortalDB << (C, #b3cde3) Vidyo >>
participant "VidyoConnect App" as VidyoConnect << (C, #b3cde3  ) Vidyo >>

participant "My Chart" as Epic << (E, #fbb4ae) EPIC >>
participant "Epic Web Service" as EPS << (E, #fbb4ae) EPIC >>


==Telehealth Visit Scheduled==
Epic -> Epic: configure visit details (name, patientID, appt time, inviteID etc..)
Epic -> Patient: Patient receives telehealth invite link with {launchToken, FHIR_Server_URL}

==Join Call flow==
Patient -> Portal: click on invite link sends {launchToken, FHIR_Server_URL}
Portal-> PortalDB: cache {launchToken, FHIR_Server_URL} with new GUID as key
Portal<--PortalDB: return GUID
Portal->VidyoEpicService: start Oauth 2.0 sequence {GUID, launchToken, FHIR_Server_URL}
VidyoEpicService->EPS : pass { launchToken } and request authorizationCode 
VidyoEpicService<--EPS : return authorizationCode
VidyoEpicService->EPS : exchange authorizationCode for accessToken 
VidyoEpicService<-EPS : get JSON data with accessToken, and meeting details (patientName, SessionID, etc.)
VidyoEpicService->VidyoEpicService : caches accessToken in KeyValue store with GUID as key
VidyoEpicService->Portal : send meeting details to Portal
Portal->Portal : create a new meeting room
Portal->Browser : create join link with roomID & other context parameters
Browser->VidyoConnect : launch VidyoConnect query params (portal, roomKey, name, etc.)
VidyoConnect->Portal: joinCall
Portal->VidyoEpicService: notify connection established for (GUID)
VidyoEpicService->VidyoEpicService: fetch accessToken for GUID
VidyoEpicService->EPS : SetExternalConnectionStatus(1)








@enduml
